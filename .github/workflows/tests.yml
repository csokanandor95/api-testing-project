name: API Tests CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ManuÃ¡lis futtatÃ¡s engedÃ©lyezÃ©se

jobs:
  test:
    name: Run API Tests
    runs-on: ubuntu-latest
    
    steps:
    # ========== KÃ“DBÃZIS CHECKOUT ==========
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # ========== PYTHON KÃ–RNYEZET BEÃLLÃTÃSA ==========
    - name: ðŸ Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'  # Gyorsabb futÃ¡s (cache-eli a pip csomagokat)
    
    # ========== FÃœGGÅSÃ‰GEK TELEPÃTÃ‰SE ==========
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ========== .ENV FÃJL LÃ‰TREHOZÃSA ==========
    - name: ðŸ”‘ Create .env file
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" > src/.env
    
    # ========== TESZTEK FUTTATÃSA ==========
    - name: ðŸ§ª Run API tests
      working-directory: ./src
      run: |
        pytest test_cases.py -v --json-report --json-report-file=reports/report.json --html=reports/report.html --self-contained-html
    
    # ========== DASHBOARD GENERÃLÃS ==========
    - name: ðŸ“Š Generate dashboard
      if: always() # Mindig fusson, mÃ©g ha a tesztek elbuknak is
      working-directory: ./src
      run: |
        python report_generator.py
    
    # ========== RIPORTOK MENTÃ‰SE ==========
    - name: ðŸ“ Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          src/reports/
          src/dashboard/
        retention-days: 30 napig tÃ¡rolja
    
    # ========== TESZTEREDMÃ‰NY Ã–SSZEGZÃ‰S ==========
    - name: ðŸ“‹ Test Summary
      if: always()
      working-directory: ./src
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "reports/report.json" ]; then
          PASSED=$(jq '.summary.passed // 0' reports/report.json)
          FAILED=$(jq '.summary.failed // 0' reports/report.json)
          TOTAL=$(jq '.summary.total // 0' reports/report.json)
          DURATION=$(jq '.summary.duration // 0' reports/report.json)
          
          echo "âœ… **Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Total:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Duration:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED" -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
        fi