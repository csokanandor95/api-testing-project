# GitHub Actions CI/CD Workflow

# Automatikusan futtatja a teszteket minden push, pull vagy manuÃ¡lis futtatÃ¡s esetÃ©n

# MÅ±kÃ¶dÃ©s:
# 1. LetÃ¶lti a kÃ³dot a repo-bÃ³l
# 2. BeÃ¡llÃ­tja a Python kÃ¶rnyezetet
# 3. TelepÃ­ti a fÃ¼ggÅ‘sÃ©geket
# 4. LÃ©trehozza a .env fÃ¡jlt (API kulccsal)
# 5. Futtatja a teszteket
# 6. GenerÃ¡lja a riportokat
# 7. Elmenti az artifactokat (letÃ¶lthetÅ‘k a GitHub-rÃ³l)
# 8. Ã–sszefoglalÃ³t kÃ©szÃ­t

name: API Tests CI/CD

on:
  push:
    branches: [ main, folder_structure_test ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ManuÃ¡lis futtatÃ¡s engedÃ©lyezÃ©se

jobs:
  test:
    name: Run API Tests
    runs-on: ubuntu-latest # VirtuÃ¡lis gÃ©p tÃ­pusa (legÃºjabb Ubuntu Linux)
    
    steps:
    # 1. lÃ©pÃ©s: KÃ³dbÃ¡zis letÃ¶ltÃ©se (checkout)
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # 2. lÃ©pÃ©s: Python kÃ¶rnyezet beÃ¡llÃ­tÃ¡sa
    - name: ðŸ Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'  # Gyorsabb futÃ¡s (cache-eli a pip csomagokat)
    
    # 3. lÃ©pÃ©s: FÃ¼ggÅ‘sÃ©gek telepÃ­tÃ©se
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. lÃ©pÃ©s: .env fÃ¡jl lÃ©trehozÃ¡sa
    - name: ðŸ”‘ Create .env file
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" > src/.env
    
    # 5. lÃ©pÃ©s: IdÅ‘bÃ©lyeg generÃ¡lÃ¡s
    - name: â° Generate timestamp
      id: timestamp
      run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
    
    # 6. lÃ©pÃ©s: Riport mappÃ¡k lÃ©trehozÃ¡sa
    - name: ðŸ“ Create reports directories
      run: |
        mkdir -p reports
        mkdir -p dashboard
    
    # 7. lÃ©pÃ©s: Tesztek futtatÃ¡sa
    - name: ðŸ§ª Run API tests
      working-directory: ./src
      env:
        TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
      run: |
        pytest test_cases.py -v \
          --json-report \
          --json-report-file=../reports/report_${TIMESTAMP}.json \
          --html=../reports/report_${TIMESTAMP}.html \
          --self-contained-html
    
    # 8. lÃ©pÃ©s: Dashboard generÃ¡lÃ¡s
    - name: ðŸ“Š Generate dashboard
      if: always() # Mindig fusson, mÃ©g ha a tesztek elbuknak is
      working-directory: ./src
      run: |
        python report_generator.py
    
    # 9. lÃ©pÃ©s: Riportok feltÃ¶ltÃ©se (artifacts)
    - name: ðŸ“ Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          reports/
          dashboard/
        retention-days: 30 # 30 napig tÃ¡rolja
    
    # 10. lÃ©pÃ©s: TeszteredmÃ©ny Ã¶sszegzÃ©s
    - name: ðŸ“‹ Test Summary
      if: always()
      # working directory nem kell mert mÃ¡r a gyÃ¶kÃ©rbÅ‘l megy
      run: |
        echo "##Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # LegutolsÃ³ JSON fÃ¡jl keresÃ©se
        JSON_FILE=$(ls -t reports/report_*.json 2>/dev/null | head -n1)
        
        if [ -f "$JSON_FILE" ]; then
          PASSED=$(jq '.summary.passed // 0' "$JSON_FILE")
          FAILED=$(jq '.summary.failed // 0' "$JSON_FILE")
          TOTAL=$(jq '.summary.total // 0' "$JSON_FILE")
          
          echo "âœ… **Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Total:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED" -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**All tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
        fi